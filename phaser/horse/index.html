<!doctype html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>hello horse!</title>
  <script src="phaser.min.js"></script>
</head>
<body>

  <script type="text/javascript">

  window.onload = function() {

    var scrollSpeed = 200;
    var width = 800;
    var height = 600;

    var horses = [];
    var running = false;
    var scrollSpeed = -100;
    var finishLine = width - 100;
    var horseVelocity = 50;
    var debugText;

    var fanfareEnabled = false; // play opening music?

    var game = new Phaser.Game(width, height, Phaser.AUTO, '', { preload: preload, create: create, update: update });

    function preload () {

      game.load.image('bg', 'assets/background.png');

      game.load.image('horse1', 'assets/horse.gif');
      game.load.image('horse2', 'assets/horse2.gif');
      game.load.image('horse3', 'assets/horse3.gif');
      game.load.image('horse4', 'assets/horse4.gif');
      game.load.image('horse5', 'assets/horse5.gif');

      game.load.audio('sfx', 'assets/post.mp3');
    }

    function startRace() {
      running = true;
      game.background.autoScroll(scrollSpeed, 0); // px / sec
      for (var i = horses.length - 1; i >= 0; i--) {
        var v = horseVelocity + game.rnd.integerInRange(0,horseVelocity*0.5);
        horses[i].body.velocity.x = v;
      };
    }

    function stopRace() {
      running = false;
      game.background.autoScroll(0, 0); // px / sec
      for (var i = horses.length - 1; i >= 0; i--) {
        horses[i].body.velocity.x = 0;
      };
    }

    function setDebug(mesg) {
      if (debugText) {
        debugText.destroy();
      }

      var style = {fill: "#ffffff"};
      var x = 50, y = game.world.height - 50;
      debugText = game.add.text(x, y, mesg, style);
    }

    function create () {

      game.background = game.add.tileSprite(0,0, game.world.width, 486, 'bg');

      game.physics.startSystem(Phaser.Physics.ARCADE);

      var margin = 198 - 32; // stands minus half a horse
      var pad = 0;
      var horseHeight = 64;
      for (var i=0; i<5; i++) {
        var y = margin + i * (pad + horseHeight);
        var key = 'horse'+(i+1);
        horses[i] = game.add.sprite(0, y, key);
        game.physics.arcade.enableBody(horses[i]);
      };

      if (fanfareEnabled) {
        var sfx = game.add.audio('sfx');
        sfx.addMarker('start', 0, 6);
        sfx.onStop.add(startRace, this);
        sfx.play('start');
      } else {
        startRace();
      }
    }

    function leadHorse() {
      var leader = horses[0];
      for (var i = horses.length - 1; i >= 0; i--) {
        if (horses[i].world.x > leader.world.x) {
          leader = horses[i];
        }
      };
      return leader;
    }

    function update () {
      var leader = leadHorse();
      var mesg = "Leader xpos: " + Math.floor(leader.world.x);

      setDebug(mesg);

      if (leader.world.x >= finishLine) {
        stopRace();
      }
    }
  };

  </script>

</body>
</html>