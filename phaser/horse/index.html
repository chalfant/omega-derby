<!doctype html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>hello horse!</title>
  <script src="phaser.min.js"></script>
</head>
<body>

  <script type="text/javascript">

  // TODO:
  // Put numbers on horses
  // Blink top two finishers
  // put horses in group? might make some calcs easier

  window.onload = function() {

    var width        = 800;
    var height       = 600;
    var scrollSpeed  = -200;
    var standsHeight = 198;
    var trackHeight  = 288;
    var horseHeight  = 64;
    var raceDuration = 10;

    var horses = [];
    var finishLine;
    var debugText;
    var running        = false;
    var fanfareEnabled = false; // play opening music?

    var game = new Phaser.Game(width, height, Phaser.AUTO, '', { preload: preload, create: create, update: update });

    function preload () {

      game.load.image('bg', 'assets/background.png');
      game.load.image('finish', 'assets/finish.png');

      game.load.image('horse1', 'assets/horse.gif');
      game.load.image('horse2', 'assets/horse2.gif');
      game.load.image('horse3', 'assets/horse3.gif');
      game.load.image('horse4', 'assets/horse4.gif');
      game.load.image('horse5', 'assets/horse5.gif');

      game.load.audio('sfx', 'assets/post.mp3');
    }

    function startRace() {
      running = true;
      game.background.autoScroll(scrollSpeed, 0); // px / sec

      var baseV = (game.world.width - 64) / (raceDuration+1);

      for (var i = horses.length - 1; i >= 0; i--) {
        var v = baseV - game.rnd.integerInRange(0,baseV*0.5);
        horses[i].body.velocity.x = v;
      };
      // hack horse #1 to have max V
      horses[0].body.velocity.x = baseV
    }

    function stopRace() {
      running = false;
      game.background.autoScroll(0, 0); // px / sec
      for (var i = horses.length - 1; i >= 0; i--) {
        horses[i].body.velocity.x = 0;
      };
      finishLine.body.velocity.x = 0;
    }

    function setDebug(mesg) {
      if (debugText) {
        debugText.destroy();
      }

      var style = {fill: "#ffffff"};
      var x = 50, y = game.world.height - 50;
      debugText = game.add.text(x, y, mesg, style);
    }

    // start finish line scrolling to left
    function spawnFinishLine() {
      finishLine.body.velocity.x = scrollSpeed;
    }

    function create () {

      game.background = game.add.tileSprite(0,0, game.world.width, 486, 'bg');

      game.physics.startSystem(Phaser.Physics.ARCADE);

      // The finishLine sprite starts the game just out of bounds
      // to the right. We will start it moving to the left
      // after raceDuration seconds.
      finishLine = game.add.sprite(game.world.width, standsHeight, 'finish');
      game.physics.arcade.enableBody(finishLine);

      // Spread the horses out vertically at the starting line
      var margin = standsHeight - horseHeight/2;
      for (var i=0; i<5; i++) {
        var y = margin + i * horseHeight;
        var key = 'horse'+(i+1);
        var h = game.add.sprite(0, y, key);
        game.physics.arcade.enableBody(h);

        // Set collision body in rear half of horse so
        // when it collides with the finish line it
        // overlaps some.
        h.body.setSize(32,64,0,0);

        horses[i] = h;
      };

      if (fanfareEnabled) {
        var sfx = game.add.audio('sfx');
        sfx.addMarker('start', 0, 6);
        sfx.onStop.add(startRace, this);
        sfx.play('start');
      } else {
        startRace();
      }

      // When this event fires, the finish line will appear
      // and start moving left.
      game.time.events.add(raceDuration * Phaser.Timer.SECOND, spawnFinishLine);
    }

    function leadHorse() {
      var leader = horses[0];
      for (var i = horses.length - 1; i >= 0; i--) {
        if (horses[i].world.x > leader.world.x) {
          leader = horses[i];
        }
      };
      return leader;
    }

    function lastHorse() {
      var last = horses[0];
      for (var i = horses.length - 1; i >= 0; i--) {
        if (horses[i].world.x < last.world.x) {
          last = horses[i];
        }
      };
      return last;
    }

    function update () {
      //var horse = lastHorse();
      var horse = leadHorse();
      var mesg = "Xpos: " + Math.floor(horse.world.x);
      mesg += "\nTimer: " + game.time.events.duration;

      setDebug(mesg);

      // Stop the race when the lead horse crosses the finish
      game.physics.arcade.collide(horse, finishLine, stopRace);
    }
  };

  </script>

</body>
</html>