<!doctype html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>hello horse!</title>
  <script src="phaser.min.js"></script>
</head>
<body>

  <script type="text/javascript">

  // TODO:
  // Put numbers on horses
  // Blink top two finishers
  // let all the horses run past the finish line
  //  ** use bounding box intersection detection to
  //     find the horses which have crossed, then
  //     stop the game when all horses have crossed.

  window.onload = function() {

    var width            = 800;
    var height           = 600;
    var scrollSpeed      = -200;
    var standsHeight     = 198;
    var trackHeight      = 288;
    var horseHeight      = 64;
    var raceDuration     = 30;
    var finishLineMargin = 100;

    var ticks        = 5; // number of velcity changes
    var tickDuration = raceDuration / ticks
    var tick         = 0;

    var horses;
    var rockingTweens = [];
    var finishLine;
    var debugText;
    var running        = false;
    var fanfareEnabled = false; // play opening music?

    var vectors = [
      [16,22,31,16,37],
      [21,22,15,16,48],
      [16,15,13,21,58],
      [15,21,14,28,44],
      [35,17,16,31,23],
      [19,28,33,27,15],
      [30,27,16,29,20],
      [12,33,14,37,26],
      [20,21,19,33,28],
      [31,31,12,35,13],
      [18,29,13,14,49],
      [24,16,21,23,38],
      [13,21,19,17,52],
      [21,19,26,13,44],
      [29,32,24,13,25],
      [21,27,20,26,28],
      [13,28,33,15,33],
      [14,29,32,26,21],
      [28,25,23,20,26],
      [29,19,14,17,44]
    ];

    var horseColors = [
      '#ff0000', // red
      '#ff66ff', // purple
      '#00ff00', // green
      '#66ffff', // cyan
      '#0000ff', // blue
    ];

    var game = new Phaser.Game(width, height, Phaser.AUTO, '', { preload: preload, create: create, update: update });

    function preload () {

      game.load.image('bg', 'assets/background.png');
      game.load.image('finish', 'assets/finish.png');

      game.load.image('horse1', 'assets/horse.gif');
      game.load.image('horse2', 'assets/horse2.gif');
      game.load.image('horse3', 'assets/horse3.gif');
      game.load.image('horse4', 'assets/horse4.gif');
      game.load.image('horse5', 'assets/horse5.gif');

      game.load.audio('sfx', 'assets/post.mp3');
    }

    function startRace() {
      console.log("Starting race.");

      chooseVelocities(); // pick random velocity vectors

      running = true;
      game.background.autoScroll(scrollSpeed, 0); // px / sec

      startRockingTweens();

      tick = 0;
      setVelocities();
    }

    function shuffle(array) {
      var m = array.length, t, i;

      while (m) {
        i = Math.floor(Math.random() * m--);

        t = array[m];
        array[m] = array[i];
        array[i] = t;
      }

      return array;
    }

    function chooseVelocities() {
      vectors = shuffle(vectors);
      for (var i = 0; i < horses.total; i++) {
        vectors[i] = shuffle(vectors[i]);
      };
    }

    function setVelocities() {
      for (var i = 0; i < horses.total; i++) {
        if (running) {
          var horse = horses.getAt(i);
          horse.body.velocity.x = vectors[i][tick];
          console.log("tick: " + tick + " horse" + (i+1) + " " + horse.body.velocity.x);
        }
      };
      if (tick < ticks-1) {
        game.time.events.add(Phaser.Timer.SECOND*tickDuration, setVelocities);
        tick++;
      }
    }

    function sortHorsesByPosition() {
      horses.sort('x', Phaser.Group.SORT_DESCENDING);
    }

    function stopRace() {
      console.log("Stopping race.");

      running = false;

      game.background.autoScroll(0, 0); // px / sec
      horses.setAll('body.velocity.x', 0);
      finishLine.body.velocity.x = 0;

      stopRockingTweens();

      sortHorsesByPosition();

      var first = horses.getAt(0);
      var second = horses.getAt(1);
      displayWinners(first, second);
    }

    function displayWinners(first, second) {
      var x = 450, y = game.world.height - 100;
      //var style = {fill: horseColors[first.name-1]};
      var style = {fill: "#ffffff"};

      token_one = parseInt(first.name);
      token_two = parseInt(second.name);

      if (token_two < token_one) {
        var tmp = token_two;
        token_two = token_one;
        token_one = tmp;
      }

      mesg = "Winners: " + token_one + " - " + token_two;
      console.log(mesg);
      winnerText = game.add.text(x, y, mesg, style);
    }

    function setDebug(mesg) {
      if (debugText) {
        debugText.destroy();
      }

      var style = {fill: "#ffffff"};
      var x = 50, y = game.world.height - 100;
      debugText = game.add.text(x, y, mesg, style);
    }

    function create () {

      game.background = game.add.tileSprite(0,0, game.world.width, 486, 'bg');

      game.physics.startSystem(Phaser.Physics.ARCADE);

      // The finishLine sprite starts the game just out of bounds
      // to the right. We will start it moving to the left
      // when the lead horse gets to a certain position
      finishLine = game.add.sprite(game.world.width, standsHeight, 'finish');
      game.physics.arcade.enableBody(finishLine);

      horses = game.add.group();
      horses.enableBody = true;
      horses.physicsBodyType = Phaser.Physics.ARCADE;

      // Spread the horses out vertically at the starting line
      var margin = standsHeight;
      for (var i=0; i<5; i++) {
        var y = margin + i * horseHeight;
        var h = horses.create(0, y, 'horse'+(i+1));
        h.name = i+1;

        h.anchor.setTo(0.5,0.5);

        // Set collision body in rear half of horse so
        // when it collides with the finish line it
        // overlaps some.
        // h.body.setSize(32,64,0,0);
      };

      if (fanfareEnabled) {
        var sfx = game.add.audio('sfx');
        sfx.addMarker('start', 0, 6);
        sfx.onStop.add(startRace, this);
        sfx.play('start');
      } else {
        startRace();
      }
    }

    function stopRockingTweens() {
      game.tweens.removeAll();
    }

    function startRockingTweens() {
      var tweenTime = 200;
      var rockAngle = 10;
      for (var i = 0; i < horses.total; i++) {
        var horse = horses.getAt(i);
        var tween = game.add.tween(horse).to(
          {angle: -rockAngle},
          tweenTime,   // time in ms
          Phaser.Easing.Linear.None)
        .to(
          {angle: rockAngle},
          tweenTime,
          Phaser.Easing.Linear.None)
        .loop()
        .start();

        rockingTweens[i] = tween;
      };
    }

    function leadHorse() {
      sortHorsesByPosition();
      return horses.getAt(0);
    }

    function update () {
      var leader = leadHorse();

      var mesg = "Xpos: " + Math.floor(leader.world.x);
      mesg += "\nTimer: " + game.time.events.duration;
      mesg += "\nTick: " + tick;

      setDebug(mesg);

      if (leader.world.x >= game.world.width - 2*finishLineMargin) {
        finishLine.body.velocity.x = -leader.body.velocity.x;
      }

      // if you dont want the line to stop the horses, dont check
      // for collision.
      //game.physics.arcade.collide(horses, finishLine, stopRace);
    }
  };

  </script>

</body>
</html>